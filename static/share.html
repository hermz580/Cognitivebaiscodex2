<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- OG / Twitter card meta — updated by JS after data loads -->
  <meta property="og:type"        content="article" />
  <meta property="og:site_name"   content="Cognitive Bias Codex" />
  <meta property="og:title"       id="og-title"       content="Cognitive Bias Scan Result" />
  <meta property="og:description" id="og-description" content="Scan result from the Cognitive Bias Codex scanner." />
  <meta name="twitter:card"       content="summary" />
  <meta name="twitter:title"      id="tw-title"       content="Cognitive Bias Scan Result" />
  <meta name="twitter:description" id="tw-desc"       content="Scan result from the Cognitive Bias Codex scanner." />

  <title>Scan Result — Cognitive Bias Codex</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />

  <style>
    :root { --bg: #101322; --surface: #171b2f; --primary: #1337ec; --accent: #6c63ff; }
    body { background: var(--bg); color: #f0f0f8; min-height: 100vh; font-family: ui-sans-serif, system-ui, sans-serif; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.10); border-radius: 1rem; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .badge-bias     { background: rgba(99, 102, 241, 0.25); color: #a5b4fc; }
    .badge-fallacy  { background: rgba(239, 68, 68, 0.22); color: #fca5a5; }
    .badge-high     { background: rgba(34, 197, 94, 0.22); color: #86efac; }
    .badge-medium   { background: rgba(234, 179, 8, 0.22); color: #fde68a; }
    .badge-low      { background: rgba(148, 163, 184, 0.18); color: #94a3b8; }
  </style>
</head>
<body class="p-4 sm:p-8 max-w-xl mx-auto">

  <!-- Header -->
  <div class="flex items-center gap-3 mb-6">
    <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:var(--primary)">
      <span class="material-icons-round text-white text-lg">psychology</span>
    </div>
    <div>
      <h1 class="font-bold text-white text-lg leading-tight">Cognitive Bias Codex</h1>
      <p class="text-xs text-slate-400">Scan result</p>
    </div>
    <a href="/" class="ml-auto text-xs text-indigo-400 hover:text-indigo-300 underline">Open app →</a>
  </div>

  <!-- Loading state -->
  <div id="loading" class="glass p-6 text-center text-slate-400">
    <span class="material-icons-round animate-spin text-3xl mb-2 block">autorenew</span>
    Loading result…
  </div>

  <!-- Error state -->
  <div id="error" class="glass p-6 text-center text-red-400 hidden">
    <span class="material-icons-round text-3xl mb-2 block">error_outline</span>
    <p id="error-msg">Result not found or expired.</p>
    <a href="/" class="mt-4 inline-block text-sm text-indigo-400 underline">Scan something new →</a>
  </div>

  <!-- Result -->
  <div id="result" class="hidden space-y-4">
    <!-- Scene -->
    <div class="glass p-4">
      <p class="text-xs font-semibold text-indigo-400 uppercase tracking-wider mb-1">Scene</p>
      <p id="scene-text" class="text-sm text-slate-200 leading-relaxed"></p>
      <p id="backend-note" class="text-xs text-slate-500 mt-2"></p>
    </div>

    <!-- Detected biases -->
    <div class="glass p-4">
      <p class="text-xs font-semibold text-indigo-400 uppercase tracking-wider mb-3">Detected concepts</p>
      <div id="bias-list" class="space-y-3"></div>
    </div>

    <!-- Share / CTA row -->
    <div class="flex gap-3">
      <button id="share-btn"
        class="flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-semibold text-white"
        style="background:var(--primary)">
        <span class="material-icons-round text-sm">share</span> Share
      </button>
      <a href="/"
        class="flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-semibold text-slate-300 glass">
        <span class="material-icons-round text-sm">camera_alt</span> Scan yours
      </a>
    </div>

    <!-- Timestamp -->
    <p id="timestamp" class="text-xs text-slate-600 text-center"></p>
  </div>

  <script>
    const BACKEND_NOTES = {
      anthropic:   "✓ Full vision analysis via Anthropic Claude",
      huggingface: "✓ Cloud vision via BLIP + Hugging Face",
      local_llm:   "⚠ Local text analysis (no image processing)",
    };

    const CONFIDENCE_CLASS = { high: "badge-high", medium: "badge-medium", low: "badge-low" };

    async function load() {
      const parts   = window.location.pathname.split("/");
      const id      = parts[parts.length - 1];
      const loading = document.getElementById("loading");
      const errEl   = document.getElementById("error");
      const resultEl= document.getElementById("result");

      try {
        const resp = await fetch(`/result/${id}`);
        if (!resp.ok) throw new Error(resp.status === 404 ? "Result not found or expired." : "Server error.");
        const data = await resp.json();

        // Update OG tags for the current session (useful if page is re-shared)
        const biasNames  = (data.detected || []).map(b => b.name).slice(0, 3).join(", ");
        const ogTitle    = `Bias scan: ${biasNames || "No biases found"}`;
        const ogDesc     = data.scene ? data.scene.slice(0, 160) : "Scan result from Cognitive Bias Codex.";
        document.title = `${ogTitle} — Cognitive Bias Codex`;

        // Scene
        document.getElementById("scene-text").textContent = data.scene || "(no scene description)";
        document.getElementById("backend-note").textContent = BACKEND_NOTES[data.backend_used] || "";

        // Biases
        const list = document.getElementById("bias-list");
        if (!data.detected || data.detected.length === 0) {
          list.innerHTML = '<p class="text-sm text-slate-400 italic">No biases detected.</p>';
        } else {
          list.innerHTML = data.detected.map(b => `
            <div class="border border-white/10 rounded-xl p-3">
              <div class="flex flex-wrap items-center gap-2 mb-1">
                <span class="font-semibold text-white text-sm">${esc(b.name)}</span>
                <span class="badge ${b.type === "fallacy" ? "badge-fallacy" : "badge-bias"}">${esc(b.type || "bias")}</span>
                <span class="badge ${CONFIDENCE_CLASS[b.confidence] || 'badge-medium'}">${esc(b.confidence || "medium")}</span>
              </div>
              <p class="text-xs text-slate-400 leading-relaxed">${esc(b.reason)}</p>
              ${b.url ? `<a href="${esc(b.url)}" target="_blank" rel="noopener" class="text-xs text-indigo-400 hover:underline mt-1 inline-block">Learn more →</a>` : ""}
            </div>
          `).join("");
        }

        // Timestamp
        if (data.ts) {
          const d = new Date(data.ts * 1000);
          document.getElementById("timestamp").textContent = `Scanned on ${d.toLocaleDateString()} at ${d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})}`;
        }

        loading.classList.add("hidden");
        resultEl.classList.remove("hidden");

        // Share button
        document.getElementById("share-btn").addEventListener("click", async () => {
          const url = window.location.href;
          const text = `I scanned something and found: ${biasNames || "cognitive biases"}. Check it out on Cognitive Bias Codex!`;
          if (navigator.share) {
            try { await navigator.share({ title: ogTitle, text, url }); } catch(_) {}
          } else {
            await navigator.clipboard.writeText(url);
            document.getElementById("share-btn").textContent = "✓ Link copied!";
            setTimeout(() => {
              document.getElementById("share-btn").innerHTML = '<span class="material-icons-round text-sm">share</span> Share';
            }, 2000);
          }
        });

      } catch(e) {
        loading.classList.add("hidden");
        document.getElementById("error-msg").textContent = e.message;
        errEl.classList.remove("hidden");
      }
    }

    function esc(s) {
      return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    load();
  </script>
</body>
</html>
