<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cognitive Bias Codex</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: { primary: "#1337ec", bg: "#101322", surface: "#171b2f" },
          fontFamily: { sans: ["Inter", "sans-serif"] },
        },
      },
    };
  </script>
  <style>
    body { font-family: "Inter", sans-serif; background: #101322; color: #e2e8f0; }
    .glass { background: rgba(16,19,34,0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
    .glass-card { background: linear-gradient(145deg, rgba(23,27,47,0.6) 0%, rgba(16,19,34,0.8) 100%); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.05); }
    .no-scroll::-webkit-scrollbar { display: none; }
    .no-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .tab-panel { display: none; }
    .tab-panel.active { display: flex; flex-direction: column; flex: 1; }
    #videoEl { width: 100%; height: 100%; object-fit: cover; border-radius: 0.75rem; }
    #canvasEl { display: none; }
    .conf-high   { background: rgba(16,185,129,0.15); color: #10b981; border: 1px solid rgba(16,185,129,0.3); }
    .conf-medium { background: rgba(245,158,11,0.15);  color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
    .conf-low    { background: rgba(239,68,68,0.15);   color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
    .type-bias         { background: rgba(19,55,236,0.15);  color: #6ea0ff; border: 1px solid rgba(19,55,236,0.3); }
    .type-fallacy      { background: rgba(168,85,247,0.15); color: #c084fc; border: 1px solid rgba(168,85,247,0.3); }
    .type-mental_model { background: rgba(16,185,129,0.15); color: #10b981; border: 1px solid rgba(16,185,129,0.3); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 0.8s linear infinite; }
    .glow-tl { position:fixed; top:-10%; left:-20%; width:80%; height:40%; border-radius:50%; background:rgba(19,55,236,0.18); filter:blur(100px); pointer-events:none; z-index:0; }
    .glow-br { position:fixed; bottom:-10%; right:-20%; width:60%; height:40%; border-radius:50%; background:rgba(19,55,236,0.08); filter:blur(80px); pointer-events:none; z-index:0; }
  </style>
</head>

<body class="min-h-screen overflow-hidden">
  <div class="glow-tl"></div>
  <div class="glow-br"></div>

  <div class="max-w-md mx-auto min-h-screen flex flex-col relative z-10 pb-20">

    <!-- ── LIBRARY TAB ──────────────────────────────────────────────────── -->
    <div id="tab-library" class="tab-panel active">
      <header class="sticky top-0 z-50 glass px-5 pt-12 pb-4 rounded-b-xl">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-[10px] font-bold tracking-widest uppercase text-primary mb-0.5">Cognitive Bias Codex</p>
            <h1 class="text-xl font-bold text-white">Library</h1>
          </div>
          <div class="text-right text-xs text-slate-400 font-mono">
            <span id="totalCount">—</span> concepts
          </div>
        </div>
        <div class="relative mb-3">
          <span class="material-icons-round absolute left-3 top-1/2 -translate-y-1/2 text-primary text-sm">search</span>
          <input id="searchInput"
            class="block w-full pl-9 pr-3 py-2.5 rounded-lg bg-white/5 text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-1 focus:ring-primary/50 transition-all"
            placeholder="Search biases, fallacies, models…" type="text" />
        </div>
        <div class="flex gap-2 overflow-x-auto no-scroll">
          <button data-filter="" class="filter-btn flex-shrink-0 px-3 py-1 rounded-full text-[11px] font-medium bg-primary text-white border border-primary">All</button>
          <button data-filter="bias" class="filter-btn flex-shrink-0 px-3 py-1 rounded-full text-[11px] font-medium bg-white/5 text-slate-300 border border-white/10 hover:bg-white/10">Biases</button>
          <button data-filter="fallacy" class="filter-btn flex-shrink-0 px-3 py-1 rounded-full text-[11px] font-medium bg-white/5 text-slate-300 border border-white/10 hover:bg-white/10">Fallacies</button>
          <button data-filter="mental_model" class="filter-btn flex-shrink-0 px-3 py-1 rounded-full text-[11px] font-medium bg-white/5 text-slate-300 border border-white/10 hover:bg-white/10">Mental Models</button>
        </div>
      </header>
      <main class="flex-1 overflow-y-auto px-4 pt-4 space-y-3" id="conceptList">
        <div class="flex items-center justify-center py-12">
          <div class="w-6 h-6 rounded-full border-2 border-primary border-t-transparent spinner"></div>
        </div>
      </main>
      <div class="px-4 pb-4 pt-2">
        <button id="loadMoreBtn" class="hidden w-full py-2.5 rounded-lg text-sm font-medium text-primary border border-primary/30 hover:bg-primary/10 transition-all">Load more</button>
      </div>
    </div>

    <!-- ── SCAN TAB ──────────────────────────────────────────────────────── -->
    <div id="tab-scan" class="tab-panel">
      <header class="glass px-5 pt-12 pb-4 rounded-b-xl">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-[10px] font-bold tracking-widest uppercase text-primary mb-0.5">AR Scanner</p>
            <h1 class="text-xl font-bold text-white">Scan Scene</h1>
          </div>
          <div id="backendBadge" class="text-[10px] font-mono px-2 py-1 rounded bg-white/5 text-slate-400 border border-white/10">detecting…</div>
        </div>
      </header>
      <main class="flex-1 overflow-y-auto px-4 pt-4 pb-4 space-y-4">
        <div class="relative rounded-xl overflow-hidden bg-white/5 border border-white/10" style="height:260px;">
          <video id="videoEl" autoplay playsinline muted></video>
          <canvas id="canvasEl"></canvas>
          <div id="camPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500">
            <span class="material-icons-round text-4xl mb-2">videocam_off</span>
            <span class="text-xs">Camera off</span>
          </div>
          <div id="scanOverlay" class="hidden absolute inset-0 flex items-center justify-center bg-black/40 rounded-xl">
            <div class="flex flex-col items-center">
              <div class="w-8 h-8 rounded-full border-2 border-primary border-t-transparent spinner mb-2"></div>
              <span class="text-xs text-primary font-medium">Analyzing…</span>
            </div>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="startCamBtn" class="flex-1 py-2.5 rounded-lg text-sm font-medium bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10 flex items-center justify-center gap-2 transition-all">
            <span class="material-icons-round text-base">videocam</span>Start Camera
          </button>
          <button id="scanBtn" disabled class="flex-1 py-2.5 rounded-lg text-sm font-bold text-white flex items-center justify-center gap-2 transition-all" style="background:#1337ec;opacity:0.4;">
            <span class="material-icons-round text-base">radar</span>Scan
          </button>
        </div>
        <div id="scanResults" class="space-y-3 hidden">
          <div id="sceneDesc" class="glass-card rounded-xl p-3 text-xs text-slate-300 leading-relaxed italic"></div>
          <div id="resultsList" class="space-y-2"></div>
          <div id="backendNote" class="text-[10px] text-slate-600 text-center mt-1"></div>
        </div>
        <div id="scanError" class="hidden glass-card rounded-xl p-4 text-sm text-rose-400 border border-rose-500/20"></div>
      </main>
    </div>

  </div>

  <!-- ── BOTTOM NAV ─────────────────────────────────────────────────────── -->
  <nav class="fixed bottom-0 w-full max-w-md left-1/2 -translate-x-1/2 z-50 glass border-t border-white/5 pb-6 pt-3 px-8">
    <ul class="flex justify-around items-center">
      <li>
        <button onclick="switchTab('library')" id="nav-library" class="nav-btn flex flex-col items-center">
          <span class="material-icons-round text-primary text-2xl">auto_stories</span>
          <span class="text-[10px] font-medium text-white mt-0.5">Library</span>
        </button>
      </li>
      <li>
        <button onclick="switchTab('scan')" id="nav-scan" class="nav-btn flex flex-col items-center">
          <span class="material-icons-round text-slate-500 text-2xl">radar</span>
          <span class="text-[10px] font-medium text-slate-500 mt-0.5">Scan</span>
        </button>
      </li>
    </ul>
  </nav>

  <script>
  // ── state ──────────────────────────────────────────────────────────────────
  const S = { page:1, size:20, term:"", type:"", loading:false, hasMore:true, stream:null };

  // ── tab switching ──────────────────────────────────────────────────────────
  function switchTab(name) {
    document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
    document.getElementById("tab-" + name).classList.add("active");

    const tabs = { library: "nav-library", scan: "nav-scan" };
    Object.entries(tabs).forEach(([t, id]) => {
      const btn  = document.getElementById(id);
      const icon = btn.querySelector(".material-icons-round");
      const lbl  = btn.querySelector("span:last-child");
      const active = t === name;
      icon.className = "material-icons-round text-2xl " + (active ? "text-primary" : "text-slate-500");
      lbl.className  = "text-[10px] font-medium mt-0.5 " + (active ? "text-white" : "text-slate-500");
    });
  }

  // ── filter buttons ─────────────────────────────────────────────────────────
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".filter-btn").forEach(b => {
        b.className = b.className
          .replace("bg-primary text-white border-primary", "")
          + " bg-white/5 text-slate-300 border-white/10";
      });
      btn.className = btn.className
        .replace("bg-white/5 text-slate-300 border-white/10", "")
        + " bg-primary text-white border-primary";
      S.type = btn.dataset.filter;
      resetAndLoad();
    });
  });

  // ── search ─────────────────────────────────────────────────────────────────
  let searchTimer;
  document.getElementById("searchInput").addEventListener("input", e => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { S.term = e.target.value.trim(); resetAndLoad(); }, 320);
  });

  // ── concept list ───────────────────────────────────────────────────────────
  function resetAndLoad() {
    S.page = 1; S.hasMore = true;
    document.getElementById("conceptList").innerHTML =
      `<div class="flex items-center justify-center py-12"><div class="w-6 h-6 rounded-full border-2 border-primary border-t-transparent spinner"></div></div>`;
    loadPage(true);
  }

  async function loadPage(replace = false) {
    if (S.loading || (!S.hasMore && !replace)) return;
    S.loading = true;
    document.getElementById("loadMoreBtn").classList.add("hidden");

    const p = new URLSearchParams({ page: S.page, size: S.size });
    if (S.term) p.set("term", S.term);
    if (S.type) p.set("type", S.type);

    try {
      const res  = await fetch(`/search?${p}`);
      const data = await res.json();
      if (replace) document.getElementById("conceptList").innerHTML = "";
      if (data.items.length === 0 && replace) {
        document.getElementById("conceptList").innerHTML =
          `<p class="text-center text-sm text-slate-500 py-12">No results found.</p>`;
      }
      data.items.forEach(c => document.getElementById("conceptList").appendChild(conceptCard(c)));
      S.page++;
      S.hasMore = S.page <= data.total_pages;
      document.getElementById("loadMoreBtn").classList.toggle("hidden", !S.hasMore);
    } catch (_) {
      if (replace)
        document.getElementById("conceptList").innerHTML =
          `<p class="text-center text-sm text-rose-400 py-12">Failed to load. Is the server running?</p>`;
    } finally {
      S.loading = false;
    }
  }

  document.getElementById("loadMoreBtn").addEventListener("click", () => loadPage());

  function conceptCard(c) {
    const typePill = `type-${c.type}`;
    const typeLabel = c.type.replace("_", " ").toUpperCase();
    const desc = c.description
      ? c.description.replace(/</g,"&lt;").replace(/>/g,"&gt;").slice(0,130) + (c.description.length > 130 ? "…" : "")
      : "No description available.";
    const el = document.createElement("article");
    el.className = "glass-card rounded-xl p-4 relative overflow-hidden group hover:border-primary/40 transition-colors";
    el.innerHTML = `
      <div class="flex items-start justify-between mb-1.5">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="px-1.5 py-0.5 rounded text-[10px] font-mono border ${typePill}">${typeLabel}</span>
          ${c.category ? `<span class="text-[10px] text-slate-500 font-mono truncate max-w-[140px]">${c.category}</span>` : ""}
        </div>
        ${c.url ? `<a href="${c.url}" target="_blank" rel="noopener" class="p-1 rounded hover:bg-white/10 text-slate-500 hover:text-primary transition-colors" onclick="event.stopPropagation()"><span class="material-icons-round text-sm">open_in_new</span></a>` : ""}
      </div>
      <h3 class="text-base font-bold text-white group-hover:text-primary transition-colors mb-1.5">${c.name}</h3>
      <p class="text-xs text-slate-400 leading-relaxed">${desc}</p>`;
    return el;
  }

  // ── stats ──────────────────────────────────────────────────────────────────
  async function loadStats() {
    try {
      const data = await (await fetch("/stats")).json();
      document.getElementById("totalCount").textContent = data.total_concepts.toLocaleString();
      const badge = document.getElementById("backendBadge");
      if (data.ai_backend.includes("anthropic")) {
        badge.textContent = "vision AI ready";
        badge.style.color = "#10b981";
      } else if (data.ai_backend.includes("huggingface")) {
        badge.textContent = "HF cloud ready";
        badge.style.color = "#f59e0b";
      } else {
        badge.textContent = "local LLM only";
        badge.style.color = "#ef4444";
      }
    } catch (_) {}
  }

  // ── camera ─────────────────────────────────────────────────────────────────
  const video   = document.getElementById("videoEl");
  const canvas  = document.getElementById("canvasEl");
  const scanBtn = document.getElementById("scanBtn");
  const startBtn = document.getElementById("startCamBtn");

  startBtn.addEventListener("click", async () => {
    if (S.stream) {
      S.stream.getTracks().forEach(t => t.stop());
      S.stream = null; video.srcObject = null;
      document.getElementById("camPlaceholder").classList.remove("hidden");
      startBtn.innerHTML = `<span class="material-icons-round text-base">videocam</span>Start Camera`;
      scanBtn.disabled = true; scanBtn.style.opacity = "0.4";
      return;
    }
    try {
      S.stream = await navigator.mediaDevices.getUserMedia(
        { video: { facingMode: "environment", width: {ideal:1280}, height: {ideal:720} } }
      );
      video.srcObject = S.stream;
      document.getElementById("camPlaceholder").classList.add("hidden");
      startBtn.innerHTML = `<span class="material-icons-round text-base">videocam_off</span>Stop`;
      scanBtn.disabled = false; scanBtn.style.opacity = "1";
    } catch (_) { showScanError("Camera access denied. Please allow camera permissions."); }
  });

  scanBtn.addEventListener("click", async () => {
    if (!S.stream) return;
    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;
    canvas.getContext("2d").drawImage(video, 0, 0);
    const b64 = canvas.toDataURL("image/jpeg", 0.82).split(",")[1];

    document.getElementById("scanOverlay").classList.remove("hidden");
    document.getElementById("scanResults").classList.add("hidden");
    document.getElementById("scanError").classList.add("hidden");
    scanBtn.disabled = true;

    try {
      const res  = await fetch("/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: b64, media_type: "image/jpeg" }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Analysis failed.");
      renderResults(data);
    } catch (e) { showScanError(e.message); }
    finally {
      document.getElementById("scanOverlay").classList.add("hidden");
      scanBtn.disabled = false;
    }
  });

  function renderResults(data) {
    document.getElementById("sceneDesc").textContent = data.scene || "Scene analyzed.";
    const list = document.getElementById("resultsList");
    list.innerHTML = "";
    if (!data.detected || data.detected.length === 0) {
      list.innerHTML = `<p class="text-center text-sm text-slate-500 py-4">No biases clearly evidenced in this scene.</p>`;
    } else {
      data.detected.forEach(d => {
        const card = document.createElement("div");
        card.className = "glass-card rounded-xl p-3 space-y-1.5";
        card.innerHTML = `
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-bold text-white text-sm">${d.name}</span>
            <span class="px-1.5 py-0.5 rounded text-[10px] font-mono border conf-${d.confidence || "medium"}">${d.confidence || "medium"}</span>
            ${d.type ? `<span class="px-1.5 py-0.5 rounded text-[10px] font-mono border type-${d.type}">${d.type.replace("_"," ")}</span>` : ""}
          </div>
          <p class="text-xs text-slate-400 leading-relaxed">${d.reason}</p>
          ${d.category ? `<p class="text-[10px] text-slate-600 font-mono">${d.category}${d.subcategory ? " › " + d.subcategory : ""}</p>` : ""}
          ${d.url ? `<a href="${d.url}" target="_blank" rel="noopener" class="text-[10px] text-primary hover:underline flex items-center gap-1"><span class="material-icons-round text-xs">open_in_new</span>Learn more</a>` : ""}`;
        list.appendChild(card);
      });
    }
    const notes = {
      anthropic:    "✓ Vision analysis via Anthropic Claude",
      huggingface:  "⚠ Cloud text analysis via Hugging Face (image not processed)",
      local_llm:    "⚠ Local text analysis (image not processed — home network only)",
    };
    document.getElementById("backendNote").textContent = notes[data.backend_used] || "";
    document.getElementById("scanResults").classList.remove("hidden");
  }

  function showScanError(msg) {
    const el = document.getElementById("scanError");
    el.textContent = msg;
    el.classList.remove("hidden");
  }

  // init
  loadStats();
  loadPage(true);
  </script>
</body>
</html>
